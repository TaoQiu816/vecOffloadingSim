# 配置参数适配性调整总结

## 调整目标

基于训练数据分析（runs/run_20260105_021203），发现以下问题：
- Task success rate = 0%
- 策略错误收敛到100% RSU
- Entropy持续增长（0.5→2.3），未收敛
- 传输时间过长（12车共享RSU需15秒 > 10秒episode）

**核心目标**: 让V2I和V2V协同卸载体现收益，促进任务高效执行

---

## 一、环境参数调整 (configs/config.py)

### 1.1 带宽参数

| 参数 | 修改前 | 修改后 | 理由 |
|------|--------|--------|------|
| `BW_V2I` | 20e6 (20Mbps) | **50e6 (50Mbps)** | 支持12车协同卸载，传输时间从15s降至3s |
| `BW_V2V` | 10e6 (10Mbps) | 10e6 (保持) | 保持V2V与V2I的差异性 |

**效果预估:**
- RSU(12车): 传输15s → 2.88s ✓可完成
- RSU单车: 传输1.25s → 0.24s，总时间1.88s → 0.70s（比本地快75%）

---

### 1.2 计算量参数

| 参数 | 修改前 | 修改后 | 理由 |
|------|--------|--------|------|
| `MIN_COMP` | 0.3e9 (0.3G) | **1.0e8 (0.1G)** | 降至参考文献的10倍，本地执行可行但有压力 |
| `MAX_COMP` | 1.2e9 (1.2G) | **1.0e9 (1.0G)** | 降低17%，创造合理的卸载需求 |

**设计原理:**
- 本地单DAG: 0.28s → 2.75s（55步）- 有压力
- 多DAG并发产生明显队列，创造卸载动机
- 参考文献使用1e7-1e8 cycles，我们使用10倍以适应12车场景

---

### 1.3 数据量参数

| 参数 | 修改前 | 修改后 | 理由 |
|------|--------|--------|------|
| `MIN_DATA` | 1.0e6 (125KB) | **4.0e5 (50KB)** | 降至参考文献范围，减少传输瓶颈 |
| `MAX_DATA` | 4.0e6 (500KB) | **2.0e6 (250KB)** | 降至参考文献中值，平衡传输时间 |
| `MIN_EDGE_DATA` | 0.2e6 (25KB) | **8.0e5 (100KB)** | 增至参考文献最小值（之前偏小） |
| `MAX_EDGE_DATA` | 0.6e6 (75KB) | **4.0e6 (500KB)** | 增至参考文献最大值，符合真实场景 |

**与参考文献对比:**
- 节点数据: 50-250KB（参考50-500KB的50%-100%）
- 边数据: 100-500KB（完全符合参考文献）
- 计算量: 0.1-1.0G cycles（参考文献10倍，适应多车竞争）

---

## 二、训练参数调整 (configs/train_config.py)

### 2.1 探索与收敛控制

| 参数 | 修改前 | 修改后 | 理由 |
|------|--------|--------|------|
| `ENTROPY_COEF` | 0.01 | **0.005** | 降低50%，抑制过度探索（entropy从0.5增至2.3） |
| `MINI_BATCH_SIZE` | 128 | **256** | 增加批量大小，提升训练稳定性 |

**预期效果:**
- Entropy收敛到0.5-1.0（合理范围）
- 梯度更稳定，减少方差

---

### 2.2 Logit Bias调整（关键）

| 参数 | 修改前 | 修改后 | 理由 |
|------|--------|--------|------|
| `LOGIT_BIAS_RSU` | 5.0 | **2.0** | 降低60%，避免100% RSU收敛 |
| `LOGIT_BIAS_LOCAL` | 2.0 | **1.5** | 降低25%，平衡Local/RSU/V2V |
| `BIAS_MIN_RSU` | 0.0 | **0.5** | 设置最小值，保持RSU探索 |
| `BIAS_MIN_LOCAL` | 0.0 | **0.5** | 设置最小值，保持Local探索 |

**Bias退火调整:**
- `BIAS_DECAY_EVERY_EP`: 100 → 200（更缓慢的衰减）
- `BIAS_DECAY_RSU`: 1.0 → 0.5（每次衰减减少量）
- `BIAS_DECAY_LOCAL`: 0.5 → 0.3（每次衰减减少量）

**预期Decision分布:**
- Local: 30-40%（CPU空闲时）
- RSU: 40-50%（主要卸载目标）
- V2V: 10-20%（邻居协同）

---

### 2.3 训练流程控制

| 参数 | 修改前 | 修改后 | 理由 |
|------|--------|--------|------|
| `MAX_EPISODES` | 200 | **1500** | 增加7.5倍，充分训练 |
| `LR_DECAY_STEPS` | 100 | **200** | 适应更长训练周期 |
| `SAVE_INTERVAL` | 100 | **200** | 减少checkpoint数量（1500/200=7个） |
| `EVAL_INTERVAL` | 50 | 50（保持） | 每50个episode评估一次 |
| `LOG_INTERVAL` | 10 | 10（保持） | 保持日志频率 |

---

## 三、对比与验证

### 3.1 参数合理性验证

**场景1: 本地执行（单DAG）**
```
计算量: 5.5G cycles
时间: 5.5G / 2GHz = 2.75s (55步)
结论: 有压力，多DAG会产生队列 ✓
```

**场景2: RSU单车独占**
```
传输: 12Mbit / 50Mbps = 0.24s
计算: 5.5G / 12GHz = 0.46s
总时间: 0.70s (14步)
收益: 比本地快75% ✓
```

**场景3: RSU 12车共享**
```
传输: 12Mbit × 12 / 50Mbps = 2.88s (58步)
计算: 并行处理（4核）
总时间: ~3s < 10s ✓可完成
```

**场景4: V2V协同**
```
传输: 12Mbit / 10Mbps = 1.2s
计算: 取决于邻居CPU
适用: 邻居空闲 + 距离近时有收益 ✓
```

---

### 3.2 与参考文献对比

| 维度 | 参考文献 | 当前配置 | 关系 |
|------|---------|---------|------|
| 计算量 | 1e7-1e8 cycles | 1e8-1e9 cycles | 10倍（适应多车） |
| 节点数据 | 50-500KB | 50-250KB | 50%-100% |
| 边数据 | 100-500KB | 100-500KB | 完全一致 ✓ |
| 带宽 | - | 50Mbps | 5G/WiFi6现实 |

---

## 四、预期训练效果

### 4.1 关键指标预期

| 指标 | 修改前 | 预期修改后 |
|------|--------|-----------|
| Task Success Rate | 0% | > 60% |
| Subtask Success Rate | 10% | > 80% |
| Decision (Local) | 0-5% | 30-40% |
| Decision (RSU) | 95-100% | 40-50% |
| Decision (V2V) | 0-5% | 10-20% |
| Entropy | 持续增长(0.5→2.3) | 收敛到0.5-1.0 |
| Reward | 无增长 | 稳定增长 |

### 4.2 训练稳定性预期

- ✓ 无Episode 92-99式崩溃
- ✓ Critic loss稳定在< 10
- ✓ Entropy收敛而非发散
- ✓ 策略不再单一选择RSU

---

## 五、下一步操作

1. **运行新训练**
```bash
python train.py --episodes 1500
```

2. **监控关键指标**
   - Task success rate是否> 0%
   - Decision分布是否平衡
   - Entropy是否收敛
   - Reward是否增长

3. **对比分析**
   - 使用test_plotting.py生成20张图表
   - 对比修改前后的performance_radar.png
   - 查看reward_decomposition.png理解策略

4. **如仍有问题**
   - 微调ENTROPY_COEF（0.003-0.01）
   - 调整LOGIT_BIAS（1.5-3.0）
   - 增加MINI_BATCH_SIZE（512）

---

## 六、修改文件清单

### 已修改文件
1. `configs/config.py`
   - BW_V2I, MIN_COMP, MAX_COMP
   - MIN_DATA, MAX_DATA, MIN_EDGE_DATA, MAX_EDGE_DATA

2. `configs/train_config.py`
   - MAX_EPISODES, LR_DECAY_STEPS
   - ENTROPY_COEF, MINI_BATCH_SIZE
   - LOGIT_BIAS_RSU, LOGIT_BIAS_LOCAL
   - BIAS_DECAY_*, BIAS_MIN_*
   - SAVE_INTERVAL

### 新增文件
3. `utils/data_recorder.py` - 新增9个绘图方法
4. `PLOTTING_GUIDE.md` - 绘图指南
5. `test_plotting.py` - 测试脚本
6. `CONFIG_UPDATE_SUMMARY.md` - 本文档

---

## 七、理论基础

### 7.1 卸载收益原理

**收益来源:**
1. **计算卸载**: RSU算力（12GHz）> 车辆（2GHz平均）→ 计算快6倍
2. **并行处理**: RSU 4核并行 > 车辆单核 → 多任务效率高
3. **协同分担**: V2V邻居分担 → 负载均衡

**必要条件:**
- 传输时间 < 本地计算节省的时间
- 队列等待 < 卸载收益
- 带宽竞争 < 算力优势

**当前配置满足:**
- ✓ RSU单车: 0.70s < 2.75s（本地）
- ✓ RSU 12车: 2.88s < 10s（可完成）
- ✓ 本地有队列压力（创造卸载需求）

### 7.2 参数设计哲学

**"Goldilocks Zone"（金发姑娘区）:**
- 计算量: 不太轻（本地太快）也不太重（必然超时）
- 数据量: 不太小（无传输成本）也不太大（传输瓶颈）
- 带宽: 足够支持多车但不是无限大（体现竞争）

**当前配置位于最优区:**
- 本地: 2.75s（有压力但可完成）
- RSU: 0.70-2.88s（视竞争程度）
- V2V: 视距离和邻居负载（策略需学习判断）

---

**总结**: 所有参数调整基于数学验证和参考文献对比，确保训练可行性和学习空间。
